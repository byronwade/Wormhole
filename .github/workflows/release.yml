name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.1.1)'
        required: true

env:
  CARGO_TERM_COLOR: always
  # Application branding
  APP_NAME: Wormhole
  APP_AUTHOR: Wormhole Team

permissions:
  contents: write

jobs:
  # =============================================================================
  # Create release draft
  # =============================================================================
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      version: ${{ steps.get_version.outputs.version }}
    steps:
      - uses: actions/checkout@v6

      - name: Get version from tag
        id: get_version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.get_version.outputs.version }}
          name: Wormhole v${{ steps.get_version.outputs.version }}
          body: |
            ## Wormhole v${{ steps.get_version.outputs.version }}

            A peer-to-peer distributed filesystem that mounts remote directories locally via encrypted QUIC transport. Share folders instantly with join codes - no cloud uploads required.

            ### Downloads

            #### Desktop Application (GUI)
            | Platform | Download |
            |----------|----------|
            | **Windows** | `Wormhole_${{ steps.get_version.outputs.version }}_x64-setup.exe` or `.msi` |
            | **macOS** (Universal) | `Wormhole_${{ steps.get_version.outputs.version }}_universal.dmg` |
            | **macOS** (Apple Silicon) | `Wormhole_${{ steps.get_version.outputs.version }}_aarch64.dmg` |
            | **macOS** (Intel) | `Wormhole_${{ steps.get_version.outputs.version }}_x64.dmg` |
            | **Linux** | `Wormhole_${{ steps.get_version.outputs.version }}_amd64.deb` or `.AppImage` |

            #### Command Line Tools
            | Platform | Architecture | Download | Contents |
            |----------|--------------|----------|----------|
            | **Linux** | x86_64 | `Wormhole-${{ steps.get_version.outputs.version }}-linux-x64.tar.gz` | Full CLI |
            | **Linux** | ARM64 | `Wormhole-${{ steps.get_version.outputs.version }}-linux-arm64.tar.gz` | Signal Server |
            | **Windows** | x86_64 | `Wormhole-${{ steps.get_version.outputs.version }}-windows-x64.zip` | Full CLI |
            | **macOS** | Apple Silicon | `Wormhole-${{ steps.get_version.outputs.version }}-macos-arm64.tar.gz` | Signal Server |
            | **macOS** | Intel | `Wormhole-${{ steps.get_version.outputs.version }}-macos-x64.tar.gz` | Signal Server |

            > **Note:** macOS CLI includes only the signal server due to macFUSE limitations in CI. For full functionality on macOS, use the Desktop Application.

            ### macOS Users: First Launch

            macOS may show **"Wormhole can't be opened because it is from an unidentified developer."**

            **Quick Fix (choose one):**
            1. **Right-click the app → Open → Click "Open"** in the dialog (easiest)
            2. **Run our fix script:**
               ```bash
               curl -fsSL https://raw.githubusercontent.com/byronwade/Wormhole/main/scripts/macos-fix-gatekeeper.sh | bash
               ```
            3. **Manual terminal fix:**
               ```bash
               xattr -cr /Applications/Wormhole.app
               ```

            > *Why?* Apple charges $99/year for code signing certificates. Wormhole is free & open source software.

            ### Requirements

            | Platform | Requirement |
            |----------|-------------|
            | **Windows** | [WinFSP](https://winfsp.dev/rel/) for filesystem mounting |
            | **macOS** | [macFUSE](https://osxfuse.github.io/) via `brew install --cask macfuse` |
            | **Linux** | FUSE3 via `sudo apt install fuse3` or equivalent |

            ### Quick Start

            ```bash
            # Host a folder (generates a join code)
            wormhole host ~/Projects/my-folder

            # On another machine, mount with the join code
            wormhole mount WORM-XXXX-YYYY ~/mnt/remote

            # Files are now accessible at ~/mnt/remote!
            ```

            ### Security

            - All file transfers use end-to-end encrypted QUIC connections
            - Files never touch third-party servers
            - Join codes use PAKE (Password-Authenticated Key Exchange) for secure pairing

            ### Changelog
            See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for details.

          draft: true
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # =============================================================================
  # Build Linux CLI binaries
  # =============================================================================
  build-linux:
    name: Build Linux CLI (${{ matrix.target }})
    runs-on: ubuntu-latest
    needs: create-release
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            artifact: Wormhole-${{ needs.create-release.outputs.version }}-linux-x64
            arch: x64
          - target: aarch64-unknown-linux-gnu
            artifact: Wormhole-${{ needs.create-release.outputs.version }}-linux-arm64
            arch: arm64

    steps:
      - uses: actions/checkout@v6

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libfuse3-dev pkg-config

      - name: Install cross-compilation tools
        if: matrix.target == 'aarch64-unknown-linux-gnu'
        run: |
          sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
          echo "CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc" >> $GITHUB_ENV

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Build release
        run: |
          if [ "${{ matrix.target }}" = "aarch64-unknown-linux-gnu" ]; then
            # Build only signal server for cross-compilation (no FUSE)
            cargo build --release --target ${{ matrix.target }} -p teleport-signal
          else
            cargo build --release --target ${{ matrix.target }} -p teleport-daemon -p teleport-signal
          fi

      - name: Package binaries
        run: |
          VERSION="${{ needs.create-release.outputs.version }}"
          mkdir -p dist

          # Copy binaries
          if [ -f target/${{ matrix.target }}/release/wormhole ]; then
            cp target/${{ matrix.target }}/release/wormhole dist/
          fi
          if [ -f target/${{ matrix.target }}/release/wormhole-mount ]; then
            cp target/${{ matrix.target }}/release/wormhole-mount dist/
          fi
          cp target/${{ matrix.target }}/release/wormhole-signal dist/

          # Create README
          cat > dist/README.md << EOF
          # Wormhole v${VERSION}

          Peer-to-peer distributed filesystem for instant folder sharing.

          ## Requirements
          - FUSE3: \`sudo apt install fuse3\` (or equivalent for your distro)

          ## Installation
          \`\`\`bash
          sudo mv wormhole wormhole-mount wormhole-signal /usr/local/bin/
          sudo chmod +x /usr/local/bin/wormhole*
          \`\`\`

          ## Quick Start
          \`\`\`bash
          # Host a folder
          wormhole host ~/my-folder

          # Mount on another machine
          wormhole mount WORM-XXXX-YYYY ~/mnt/remote
          \`\`\`

          ## More Info
          https://github.com/${{ github.repository }}
          EOF

          # Create LICENSE file
          cp LICENSE dist/ 2>/dev/null || echo "MIT OR Apache-2.0" > dist/LICENSE

          cd dist && tar -czvf ../Wormhole-${VERSION}-linux-${{ matrix.arch }}.tar.gz *

      - name: Upload release asset
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.create-release.outputs.version }}
          files: Wormhole-${{ needs.create-release.outputs.version }}-linux-${{ matrix.arch }}.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # =============================================================================
  # Build macOS CLI binaries (native compilation for each arch)
  # =============================================================================
  build-macos:
    name: Build macOS CLI (${{ matrix.arch }})
    runs-on: ${{ matrix.os }}
    needs: create-release
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-apple-darwin
            arch: x64
            os: macos-15
          - target: aarch64-apple-darwin
            arch: arm64
            os: macos-latest

    steps:
      - uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      # Note: macFUSE requires kernel extension approval and reboot on macOS,
      # which isn't possible in CI. We only build the signal server for CLI.
      # Users should install the Desktop app for full FUSE functionality.
      - name: Build release
        run: cargo build --release --target ${{ matrix.target }} -p teleport-signal
        env:
          MACOSX_DEPLOYMENT_TARGET: "10.15"

      - name: Code sign binaries (ad-hoc)
        run: |
          # Ad-hoc signing for distribution without Apple Developer ID
          codesign --force --deep --sign - target/${{ matrix.target }}/release/wormhole-signal || true

      - name: Package binaries
        run: |
          VERSION="${{ needs.create-release.outputs.version }}"
          mkdir -p dist

          cp target/${{ matrix.target }}/release/wormhole-signal dist/

          # Create install script
          cat > dist/install.sh << 'SCRIPT'
          #!/bin/bash
          set -e
          echo "Installing Wormhole Signal Server..."
          sudo mkdir -p /usr/local/bin
          sudo cp wormhole-signal /usr/local/bin/
          sudo chmod +x /usr/local/bin/wormhole-signal
          echo "Installed to /usr/local/bin/"
          echo ""
          echo "For full Wormhole functionality, install the Desktop app"
          echo ""
          echo "Verify with: wormhole-signal --version"
          SCRIPT
          chmod +x dist/install.sh

          # Create README
          cat > dist/README.md << EOF
          # Wormhole Signal Server v${VERSION}

          Signal server for Wormhole P2P connections (NAT traversal).

          ## What's Included
          - wormhole-signal: Signal server for peer discovery and NAT traversal

          ## Installation
          \`\`\`bash
          ./install.sh
          \`\`\`

          ## Note
          For full Wormhole functionality (hosting/mounting folders),
          download the Desktop Application from the releases page.

          The signal server is for running your own relay server.
          EOF

          cp LICENSE dist/ 2>/dev/null || echo "MIT OR Apache-2.0" > dist/LICENSE

          cd dist && tar -czvf ../Wormhole-${VERSION}-macos-${{ matrix.arch }}.tar.gz *

      - name: Upload release asset
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.create-release.outputs.version }}
          files: Wormhole-${{ needs.create-release.outputs.version }}-macos-${{ matrix.arch }}.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # =============================================================================
  # Build Windows CLI binaries
  # =============================================================================
  build-windows:
    name: Build Windows CLI (x64)
    runs-on: windows-latest
    needs: create-release

    steps:
      - uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Build release
        shell: bash
        run: |
          cargo build --release -p teleport-signal
          cargo build --release -p teleport-daemon

      - name: Package binaries
        shell: bash
        run: |
          VERSION="${{ needs.create-release.outputs.version }}"
          mkdir -p dist

          cp target/release/wormhole-signal.exe dist/
          if [ -f target/release/wormhole.exe ]; then
            cp target/release/wormhole.exe dist/
          fi
          if [ -f target/release/wormhole-mount.exe ]; then
            cp target/release/wormhole-mount.exe dist/
          fi

          # Create README
          cat > dist/README.md << 'EOF'
          # Wormhole for Windows

          Peer-to-peer distributed filesystem for instant folder sharing.

          ## Requirements
          - WinFSP: Download from https://winfsp.dev/rel/

          ## What's Included
          - wormhole.exe - Main CLI (host folders, manage connections)
          - wormhole-mount.exe - Mount remote shares via WinFSP
          - wormhole-signal.exe - Signal server for NAT traversal

          ## Quick Start
          ```
          # Host a folder
          wormhole.exe host C:\Users\You\Projects\my-folder

          # Mount a remote share
          wormhole-mount.exe 192.168.1.100:4433 W:
          ```

          ## More Info
          https://github.com/byronwade/Wormhole
          EOF

          echo "MIT OR Apache-2.0" > dist/LICENSE.txt

          cd dist && 7z a -tzip ../Wormhole-${VERSION}-windows-x64.zip *

      - name: Upload release asset
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.create-release.outputs.version }}
          files: Wormhole-${{ needs.create-release.outputs.version }}-windows-x64.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # =============================================================================
  # Build Desktop Application (Tauri)
  # =============================================================================
  build-desktop:
    name: Build Desktop App (${{ matrix.platform }})
    runs-on: ${{ matrix.os }}
    needs: create-release
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: linux
            os: ubuntu-22.04
          - platform: macos-arm64
            os: macos-latest
          - platform: macos-x64
            os: macos-15
          - platform: windows
            os: windows-latest

    steps:
      - uses: actions/checkout@v6

      - name: Check if desktop app exists
        id: check_desktop
        run: |
          if [ -d "apps/desktop" ] && [ -f "apps/desktop/package.json" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
        shell: bash

      - name: Install system dependencies (Linux)
        if: steps.check_desktop.outputs.exists == 'true' && matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libfuse3-dev pkg-config libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Install macFUSE (macOS)
        if: steps.check_desktop.outputs.exists == 'true' && startsWith(matrix.platform, 'macos')
        run: brew install --cask macfuse || true

      - name: Setup Node.js
        if: steps.check_desktop.outputs.exists == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install pnpm
        if: steps.check_desktop.outputs.exists == 'true'
        run: npm install -g pnpm

      - name: Install Rust toolchain
        if: steps.check_desktop.outputs.exists == 'true'
        uses: dtolnay/rust-toolchain@stable

      - name: Install frontend dependencies
        if: steps.check_desktop.outputs.exists == 'true'
        working-directory: apps/desktop
        run: pnpm install

      - name: Build Tauri app (Linux)
        if: steps.check_desktop.outputs.exists == 'true' && matrix.platform == 'linux'
        working-directory: apps/desktop
        run: pnpm tauri build
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

      - name: Build Tauri app (macOS)
        if: steps.check_desktop.outputs.exists == 'true' && startsWith(matrix.platform, 'macos')
        working-directory: apps/desktop
        run: pnpm tauri build
        env:
          # Only set Tauri signing keys if they exist
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY || '' }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD || '' }}
          # Note: Apple signing env vars are intentionally NOT set here
          # When APPLE_CERTIFICATE is empty but present, Tauri fails trying to import it
          # The signingIdentity: "-" in tauri.conf.json enables ad-hoc signing without Apple Developer ID

      - name: Build Tauri app (Windows)
        if: steps.check_desktop.outputs.exists == 'true' && matrix.platform == 'windows'
        working-directory: apps/desktop
        run: pnpm tauri build
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

      - name: Rename and upload Linux .deb
        if: steps.check_desktop.outputs.exists == 'true' && matrix.platform == 'linux'
        run: |
          VERSION="${{ needs.create-release.outputs.version }}"
          for f in target/release/bundle/deb/*.deb; do
            if [ -f "$f" ]; then
              # Rename to consistent format
              newname="Wormhole_${VERSION}_amd64.deb"
              cp "$f" "$newname"
              echo "ASSET_PATH=$newname" >> $GITHUB_ENV
            fi
          done
        shell: bash

      - name: Upload Linux .deb
        if: steps.check_desktop.outputs.exists == 'true' && matrix.platform == 'linux'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.create-release.outputs.version }}
          files: Wormhole_${{ needs.create-release.outputs.version }}_amd64.deb
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Linux .AppImage
        if: steps.check_desktop.outputs.exists == 'true' && matrix.platform == 'linux'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.create-release.outputs.version }}
          files: target/release/bundle/appimage/*.AppImage
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload macOS .dmg
        if: steps.check_desktop.outputs.exists == 'true' && startsWith(matrix.platform, 'macos')
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.create-release.outputs.version }}
          files: target/release/bundle/dmg/*.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Windows .msi
        if: steps.check_desktop.outputs.exists == 'true' && matrix.platform == 'windows'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.create-release.outputs.version }}
          files: target/release/bundle/msi/*.msi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Windows .exe (NSIS)
        if: steps.check_desktop.outputs.exists == 'true' && matrix.platform == 'windows'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.create-release.outputs.version }}
          files: target/release/bundle/nsis/*.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # =============================================================================
  # Generate checksums and publish release
  # =============================================================================
  finalize:
    name: Finalize Release
    runs-on: ubuntu-latest
    needs: [create-release, build-linux, build-macos, build-windows]
    # Don't require desktop build to succeed (it may not exist)
    if: always() && needs.create-release.result == 'success'
    steps:
      - name: Download all release assets
        uses: robinraju/release-downloader@v1
        with:
          tag: v${{ needs.create-release.outputs.version }}
          fileName: '*'
          out-file-path: assets

      - name: Generate checksums
        run: |
          cd assets
          echo "# Wormhole v${{ needs.create-release.outputs.version }} - SHA256 Checksums" > SHA256SUMS.txt
          echo "" >> SHA256SUMS.txt
          echo "Verify downloads with: sha256sum -c SHA256SUMS.txt" >> SHA256SUMS.txt
          echo "" >> SHA256SUMS.txt
          for f in *; do
            if [ -f "$f" ] && [ "$f" != "SHA256SUMS.txt" ]; then
              sha256sum "$f" >> SHA256SUMS.txt
            fi
          done
          echo ""
          echo "=== SHA256 Checksums ==="
          cat SHA256SUMS.txt

      - name: Upload checksums
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.create-release.outputs.version }}
          files: assets/SHA256SUMS.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish release (remove draft)
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.create-release.outputs.version }}
          draft: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
