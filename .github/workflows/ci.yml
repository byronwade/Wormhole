name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # =============================================================================
  # Check formatting and lints (core crates only - no desktop app)
  # =============================================================================
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libfuse3-dev pkg-config

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-lint-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-lint-

      - name: Check formatting
        run: cargo fmt --all -- --check

      # Only lint core crates (exclude desktop app which needs GTK)
      - name: Run clippy on core crates
        run: cargo clippy -p teleport-core -p teleport-daemon -p teleport-signal --all-targets -- -D warnings

  # =============================================================================
  # Build and test on Linux
  # =============================================================================
  test-linux:
    name: Test (Linux)
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libfuse3-dev pkg-config

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-test-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-test-

      # Build core crates only
      - name: Build core crates
        run: cargo build -p teleport-core -p teleport-daemon -p teleport-signal

      - name: Run tests
        run: cargo test -p teleport-core -p teleport-daemon -p teleport-signal

      - name: Build release
        run: cargo build --release -p teleport-daemon -p teleport-signal

  # =============================================================================
  # Build and test on macOS
  # =============================================================================
  test-macos:
    name: Test (macOS)
    runs-on: macos-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: Install macFUSE
        run: |
          brew install --cask macfuse || true
          # macFUSE may require a reboot on first install, but headers should be available

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-test-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-test-

      # Build core crates only
      - name: Build core crates
        run: cargo build -p teleport-core -p teleport-daemon -p teleport-signal

      - name: Run tests
        run: cargo test -p teleport-core -p teleport-daemon -p teleport-signal

      - name: Build release
        run: cargo build --release -p teleport-daemon -p teleport-signal

  # =============================================================================
  # Build on Windows (no FUSE tests)
  # =============================================================================
  test-windows:
    name: Test (Windows)
    runs-on: windows-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-test-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-test-

      # Build signal server only (no FUSE on Windows without WinFSP)
      - name: Build signal server
        run: cargo build -p teleport-signal -p teleport-core

      - name: Run core tests
        run: cargo test -p teleport-core

  # =============================================================================
  # Security audit
  # =============================================================================
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-audit
        run: cargo install cargo-audit

      - name: Run security audit
        run: cargo audit
        continue-on-error: true  # Don't fail CI on advisories, just report

  # =============================================================================
  # Documentation build
  # =============================================================================
  docs:
    name: Documentation
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libfuse3-dev pkg-config

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-docs-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-docs-

      # Build docs for core crates only
      - name: Build documentation
        run: cargo doc --no-deps -p teleport-core -p teleport-daemon -p teleport-signal
        env:
          RUSTDOCFLAGS: -D warnings
