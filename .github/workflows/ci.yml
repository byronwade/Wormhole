name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # =============================================================================
  # Check formatting and lints (core crates only - no desktop app)
  # =============================================================================
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libfuse3-dev pkg-config

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-lint-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-lint-

      - name: Check formatting
        run: cargo fmt --all -- --check

      # Only lint core crates (exclude desktop app which needs GTK)
      - name: Run clippy on core crates
        run: cargo clippy -p teleport-core -p teleport-daemon -p teleport-signal --all-targets -- -D warnings

  # =============================================================================
  # Build and test on Linux
  # =============================================================================
  test-linux:
    name: Test (Linux)
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v6

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libfuse3-dev pkg-config

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-test-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-test-

      # Build core crates only
      - name: Build core crates
        run: cargo build -p teleport-core -p teleport-daemon -p teleport-signal

      - name: Run tests
        run: cargo test -p teleport-core -p teleport-daemon -p teleport-signal

      - name: Build release
        run: cargo build --release -p teleport-daemon -p teleport-signal

  # =============================================================================
  # Build and test on macOS
  # =============================================================================
  test-macos:
    name: Test (macOS)
    runs-on: macos-latest
    needs: lint
    steps:
      - uses: actions/checkout@v6

      - name: Install macFUSE
        run: |
          brew install --cask macfuse || true
          # macFUSE may require a reboot on first install, but headers should be available

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-test-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-test-

      # Build core crates only
      - name: Build core crates
        run: cargo build -p teleport-core -p teleport-daemon -p teleport-signal

      - name: Run tests
        run: cargo test -p teleport-core -p teleport-daemon -p teleport-signal

      - name: Build release
        run: cargo build --release -p teleport-daemon -p teleport-signal

  # =============================================================================
  # Build on Windows (with WinFSP support)
  # =============================================================================
  test-windows:
    name: Test (Windows)
    runs-on: windows-latest
    needs: lint
    steps:
      - uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-test-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-test-

      # Build all crates including teleport-daemon with WinFSP support
      # The winfsp crate bundles the import library, so no system dependencies needed
      - name: Build all crates
        run: cargo build -p teleport-signal -p teleport-core -p teleport-daemon

      - name: Run core tests
        run: cargo test -p teleport-core

      # Note: Daemon tests requiring WinFSP runtime are skipped in CI
      # (WinFSP needs to be installed on the machine to run actual mount tests)

  # =============================================================================
  # Frontend tests (TypeScript/React)
  # =============================================================================
  test-frontend:
    name: Test (Frontend)
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        working-directory: apps/desktop
        run: pnpm install

      - name: TypeScript check
        working-directory: apps/desktop
        run: pnpm typecheck

      - name: Run tests
        working-directory: apps/desktop
        run: pnpm test:run

  # =============================================================================
  # Security audit
  # =============================================================================
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-audit
        run: cargo install cargo-audit

      - name: Run security audit
        run: cargo audit
        continue-on-error: true  # Don't fail CI on advisories, just report

  # =============================================================================
  # Documentation build
  # =============================================================================
  docs:
    name: Documentation
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v6

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libfuse3-dev pkg-config

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-docs-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-docs-

      # Build docs for core crates only
      - name: Build documentation
        run: cargo doc --no-deps -p teleport-core -p teleport-daemon -p teleport-signal
        env:
          RUSTDOCFLAGS: -D warnings
